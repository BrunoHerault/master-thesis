```{r config, message=FALSE, warning=FALSE, include=FALSE}
rm(list = ls()) ; invisible(gc())
library(knitr)
library(parallel)
library(TROLL)
library(RconTroll)
library(ggplot2)
library(ggrepel)
library(cowplot)
library(entropart)
library(plotly)
library(readr)
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 8, fig.width = 8,
    cache = T, cache.lazy = F)
```


# Materials and methods

## TROLL simulator

### Abiotic environment

### Photosynthesis

### Autotrpohic respiration

### Carbon uptake

### Tree growth

### Seed dispersion, production and recruitment

### Mortality

## TROLL sensitivity analysis

### Functional traits

### Seed rain

## Disturbance

### Disturbance module

### Design of experiment

```{r DOE, fig.cap='Experimental design before disturbance. Communities are implemented along a gradient of species richness (SR) and functional dispersion (FDis) resulting in a broad range of aboveground biomass (AGB). FDis was caluclated based on 4 functional traits (leaf mass per area, wood specific gravity, maximum diameter, maximum height).'}
# Data prep
load('~/Documents/ECOFOG/Results/disturbance/maturity/matureData.Rdata')
data <- datal$time
data <- data[data$time > 450,]
data <- data.frame(apply(data[c('agb','ba','n10','n30')],
                         2, function(x) tapply(x, data$sim, mean)))
data <- cbind(data.frame(sim = row.names(data)), data)
data$richness <- as.factor(floor(as.numeric(as.character(data$sim))))
species <- read.table('~/Documents/ECOFOG/TROLL/inst/extdata/species.txt',
                      header=T, dec=".", sep="",
                      row.names = 1)[c('LMA', 'wsg', 'dmax', 'hmax')]
species <- species[row.names(datal$species),]
fd <- suppressWarnings(FD::dbFD(species, t(datal$species), messages = F))
data <- cbind(data, do.call('cbind',
                            fd[c('FRic', 'FEve', 'FDiv', 'FDis', 'RaoQ')]))
data <- cbind(data, fd$CWM)
rm(fd, species, datal)

# Graph
g <- ggplot(data, aes(x = FDis, y = richness, 
                      label = sim, color = agb/1000)) + 
  geom_point(size = 3) + 
  geom_text_repel() +
  scale_color_continuous("Aboveground\nBiomass\n(AGB, ton C/ha)") +
  xlab("Functional dispersion (FDis)") +
  ylab("Species richness (SR)")

g ; rm(data)
```

### Outputs anlaysis ?

#### Resistance and resilience metrics

#### Biodiversity partitioning

## Selective logging

### Selective logging module

#### Designation

#### Selection

#### Rotten trees

#### Felling

#### Tracks

#### Gap damages

### Design of experiment

### Outputs analysis ?

#### Resistance and resilience metrics

#### Biodiversity partitioning
