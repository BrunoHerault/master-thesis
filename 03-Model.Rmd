# Model description

## Overview

TROLL model each tree indivdually in a located environment. Thus TROLL model, alongside with SORTIE  [@Pacala1996; @Uriarte2009] and FORMIND [@Fischer2016; @Kohler1998], can be defined as an individual-based and spatially explicit forest growth model. TROLL simulates the life cycle of individual trees from recruitment, with a diameter at breast height (dbh) above 1 cm, to death with growth and seed production. Trees are growing in a located light environment explicitly computed witin voxels of 1 $m^3$. Each tree is consistently defined by its age, diameter at brest height (dbh), height (h), crown radius (CR), crown depth (CD) and leaf area (LA) (see figure \@ref(fig:TROLLtree)). Tree geometry is calculated with allometric equations but leaf area vary dinamically within each crown following carbon allocations. Voxels resolution of 1 $m^3$ allow the establishment of maximum one tree by 1x1 m pixels. Each tree is flagged with a species label inherited from the parent tree through the seedling recruitment. A species label is associated to a number of species specific parameters (see table \@ref(tab:traits)) related to functional trait values which can be sampled on the field.

```{r traits, echo=FALSE}
table <- data.frame(
  Abbreviation = c('$LMA$', '$N_m$', '$P_m$', '$wsg$', '$dbh_{thresh}$', '$h_{lim}$', '$a_h$'),
  Description = c('leaf mass per area', 'leaf nitrogen content per dry mass', 'leaf phosphorous content per dry mass', 'wood specific gravity', 'diameter at breasth height threshold', 'asymptotic height', 'parameter of the tree-height-dbh allometry'),
  Units = c('$g.m^{-2}$', '$mg.g^{-1}$', '$mg.g^{-1}$', '$g.cm^{-3}$', '$m$', '$m$', '$m$')
)
knitr::kable(table, caption = 'Species-specific parameters used in TROLL from @Li. Data originates from the BRIDGE [@Baraloto2010] and TRY [@Kattge2011] datasets.', format = 'pandoc')
```

Carbon assimilation is computed over half-hourly period of a representative day. Then allocation is computed to simulate tree growth from an explicit carbone balance (in contrast to previous models). Finally environment is updated at each timestep set to one month. Seedlings are not simulated explicitly but as a pool. In addition belowground processes, herbaceous plants, epiphytes and lianas are not simulated inside TROLL. The source code is written in C++ and available upon request. All analyses were conducted in R version 3.4.0 **Cite R, add entry in Mendeley**.

```{r TROLLtree, echo=FALSE, fig.cap='Individuals tree inside TROLL explicit spatial grid from @Li. Tree geometry (crown radius CR, crown depth CD, height h, diameter at breast height dbh) is updated at each timestep following allometric relationship with assimilated carbon allocated to growth. Each tree is flagged with a species label linking to its species-specific attributes. Light is compputed explicitly at each timestep for each voxel.'}
knitr::include_graphics('images/TROLLtree.png', dpi = NA)
```

## Abiotic environment

A voxel space, with a resolution of 1 $m^3$, is used to explicilty model the abiotic environment. For each tree crown, leaf area density is calculated on tree geometry assuming a uniform distriution across voxels occupied by the crown. Leaf area density is computed within each voxel summing all tree crowns inside the voxel $v$, and is denoted $LAD(v)$ (leaf area per voxel in $mÂ².m^{-3}$). The vertical sum of $LAD$ from voxel $v$ to the ground level defines $LAI(v)$ (leaf area per fround area in $m^2.m^{-2}$ commonly called leaf area index):

\begin{equation}
  LAI(v) = \sum _{v'=v} ^\infty LAD(v') 
  (\#eq:LAI)
\end{equation}

Daily variations in light intensity (photosynthetic photon flux density PPFD in $\mu mol_{photons}.m^{-2}.s^{-1}$), temperature (T in degrees Celsius), and vapor pressure deficit (VPD in $kPA$) are computed to assess carbon assimilation within each voxel of the canopy and for a representative day per month (see Appendix 1 from @Li for further details). Variation of PPFD Within the canopy is calculated as a loacal Beer-Lambert extinction law:

\begin{equation}
  PPFD_{max,month}(v) = PPFD_{top,max,month}*e^{-k*LAI(v)}
  (\#eq:PPFD)
\end{equation}

The daily maximum incident PPFD at the top of canopy $PPFD_{top,max,month}$ is given as input. The extinction rate $k$ is assumed as constant, besides is variation with zenith angle and species leaf inclination angle [@Meir2000]. Moreover only vertical light diffusion is considered ignoring lateral light diffusion, which can have an important role especially in logging gaps. Finally, intra-day variation at half hour time steps $t$ for a representative day every month are used to compute $PPFD_{month}(v,t)$, $T_{month}(v,t)$ and $VPD_{month}(v,t)$. Water and nutrient process both in soil and inside trees are not simulated.

## Photosynthesis

### Theory

Troll simulates the carbon uptake of each individual with the Farquhar, von Caemmerer and Berry model of C3 photosynthesis [@Farquhar1980]. Gross carbon assimilation rate ($A$ in $\mu mol~CO_2. m^{-2}.s^{-1}$) will be the minimum of eiter Rubisco activity ($A_v$) or RuBP generation ($A_j$):

\begin{equation}
  A=min(A_v, A_j)~|~A_v=V_{cmax}*\frac{c_i-\Gamma^*}{c_i+K_m}~;~A_j=\frac{J}{4}*\frac{c_i-\Gamma^*}{c_i+2*\Gamma^*}
  (\#eq:A)
\end{equation}

$V_{cmax}$ is the maximum rate of carboxylation ($\mu mol~CO_2.m^{-2}.s^{-1}$). $c_i$ is the $CO_2$ partial pressure at carboxylation sites. $\Gamma^*$ is the $CO_2$ compensation point in absence of dark respiration. $K_m$ is the apparent knietic constant of the Rubisco. And $J$ is the electron transport rate ($\mu mol e^-.m^{-2}.s^{-1}$). $J$ depends on the light intensity with $PPFD$:

\begin{equation}
  J = \frac{1}{2*\theta}*[\alpha*PPFD+J_{max}-\sqrt{(\alpha*PPFD+J_{max})^2}-4*\theta*\alpha*PPFD*J_{max}]
  (\#eq:J)
\end{equation}

$J_{max}$ is the maximal electron transport capacity ($\mu mol e^-.m^{-2}.s^{-1}$). $\theta$ is the curvature factor. And $\alpha$ is the apparent quantum yield to electron transport ($mole^-.mol~photons^{-1}$).

Carbon assimilation by photosynthesis will then be limited by the $CO_2$ partial pressure at carboxylation sites. Stomata controls the gas concentration at carboxylation sites throught stomatal transport:

\begin{equation}
  A = g_s*(c_a-c_i)
  (\#eq:Ag)
\end{equation}

$g_s$ is the stomatal conductance to $CO_2$ ($molCO_2.m^{-2}.s^{-1}$). TROLL simulates stomatal conductance $g_s$ with the model from [@Medlyn2011]:

\begin{equation}
  g_s = g_0 + (1 + \frac{g_1}{\sqrt{VPD}})*\frac{A}{c_a}
  (\#eq:gs)
\end{equation}

$g_0$ and $g_1$ are parameters from the model. TROLL model assume $g_0 \approx 0$ (empirically tested and considered as reasonable).

### Parametrization

Leaf traits can be used as proxy of photosynthesis, especially leaf nutrient content which directly play a role in it [@wright_worldwide_2004]. @Domingues2010 suggested that $V_{cmac}$ and $J_{max}$ were both limited by the leaf concentration of nitrogen $N$ and phosphorus $P$ ($mg.g^{-1}$):

\begin{equation}
  log_{10} V_{cmax-M} = min( 
  \begin{array}{c} 
    -1.56+0.43*log_{10} N-0.37*log_{10} LMA \\
    -0.80+0.45*log_{10} P-0.25*log_{10} LMA 
  \end{array} 
  )
  (\#eq:VcmaxM)
\end{equation}

\begin{equation}
  log_{10} J_{max-M} = min(
  \begin{array}{c} 
    -1.50+0.41*log_{10} N-0.45*log_{10} LMA \\
    -0.74+0.44*log_{10} P-0.32*log_{10} LMA 
  \end{array}
  )
  (\#eq:JmaxM)
\end{equation}

$V_{cmax-M}$ and $J_{max-M}$ are the photosynthetic capacities at $25^\circ C$ of mature leaves per leaf dry mass (resp. $\mu mol CO_2.g^-1.s^{-1}$ and $\mu mol e^-.g^{-1}.s^{-1}$). $LMA$ is the leaf mass per are ($g.cm^{-2}$). $V_{cmax}$ and $J_{max}$ are calculated by multiplying $V_{cmax-M}$ and $J_{max-M}$ by $LMA$. $V_{cmax}$ and $J_{max}$ variation with temperature are caluclated with @Bernacchi2003 (see Appendix 2 from @Li for further details).

TROLL computes leaf carbon assimilation $A_l$ combining equations from \@ref(eq:A) to \@ref(eq:JmaxM) for each tree crown voxel within in each crown layer $l$:

\begin{equation}
  A_l = \frac{1}{n_v*t_M} * \sum_v  \sum^{t_M}_{t=1} A(PPFD_{month}(v,t),VPD_{month}(v,t),T_{month}(v,t))
  (\#eq:Al)
\end{equation}

$PPFD_{month}(v,t)$, $VPD_{month}(v,t)$ , and $T_{month}(v,t)$ are derived from microclimatic data. $n_v$ is the number of voxels within crown layer $l$. And the sum is calculated over the $t_M$ half-hourly intervals $t$ of a tipical day.

## Autotrophic respiration

A large fraction of plants carbon uptake is actually used for plant maintenance and growth respiration. The autotrophic respiration can represents up to 65% of the gross primary productivity but varies strongly among species, sites, and environnements.

TROLL uses @Atkin2015 database of mature leaf dark respiration and associated leaf traits to compute leaf maintenance respiration:

\begin{equation}
  R_{leaf-M} = 8.5431-0.1306*N-0.5670*P-0.0137*LMA+11.1*V_{cmax-M}+0.1876*N*P
  (\#eq:Rl)
\end{equation}

$R_{leaf-M}$ si the dark respiration rate per leaf dry mass at a temperaure of $25^\circ C$ ($nmolCO_2.g^{-1}.s^{-1}$). The other terms are in equations \@ref(eq:VcmaxM) and \@ref(eq:JmaxM). TROLL assume leaf respiration during day light to be 40% of leaf dark respiration, and computes total leaf respiration by accounting for the legnth of daylight.

TROLL model stem respiration ($R_{stem}$ in $\mu molC.s^{-1}$) with a constant respiration rate per volume of sapwood:

\begin{equation}
  R_{stem} = 39.6*\pi*ST*(dbh-ST)*(h-CD)
  (\#eq:Rs)
\end{equation}

dbh, h, CD and ST are tree diameter at breast height, height, corwn depth and sapwoond thickness, respectively ($m$). TROLL assumes $ST=0.04~m$ when $dbh>30~cm$ and an increasing $ST$ for lower $dbh$.

Finally, TROLL computes both fine root maintenance respiration, as half of the leaf maintenance respiration. Whereas coarse root and branch maintenance respiration is computed as half of the stem respiration. And growth respiration ($R_{growth}$) is assumed to account for 25% of the gross primary productivity minus the sum of maintenance respirations.

## Net carbon uptake

Net primary production of carbon for one individual $NPP_{ind}$ ($gC$) is computed by the balance between gross primary production $GPP_{ind}$ and respirations $R$:

\begin{equation}
  NPP_{ind} = GPP_{ind} - R_{maintenance} - R_{growth}
  (\#eq:NPP)
\end{equation}

TROLL partitions individuals total leaf area $LA$ into three pools for different leaf age classes corresponding to different photosynthesis efficiency (young, mature and old leaves with $LA_{young}$, $LA_{mature}$, and $LA_{old}$ respectivelly). Consequently we can compute growth primary production for one individual as:

\begin{equation}
  GPP_{ind} = 189.3 * \Delta t * \sum _{l= \lfloor h-CD \rfloor +1} ^{\lfloor h \rfloor} [A_l] * (\frac{LA_{young}}{2} + LA_{mature} + \frac{LA_{old}}{2})
  (\#eq:GPP)
\end{equation}

h and CD are tree height and crown depth, repectivelly ($m$). $\lfloor x \rfloor$ is the rounding function. $\Delta t$ is the duration of a timestep ($year$).

Thus, TROLL can compute carbon allocation to wood into an increment of stem volume $\Delta V$ ($m^3$):

\begin{equation}
  \Delta V = 10^{-6} * \frac{f_{wood}*NPP_{ind}}{0.5*wsg}*Senesc(dbh)
  (\#eq:DeltaV)
\end{equation}

$f_{wood}$ is the fixed fraction of NPP allocated to stem and branches. $wsg$ is the wood specific gravity ($g.cm^{-3}$, see \@ref(tab:traits)). TROLL assume large trees less efficient to convert NPP as growth by using a size-related growth decline with function $Senesc$ after a specific diameter at brest height threshold $dbh_{thresh}$:

\begin{equation}
  Senesc(dbh) = max(0;3-2*\frac{dbh}{dbh_{thresh}})
  (\#eq:Senesc)
\end{equation}

Finally, TROLL can compute carbon allocation to canopy with canopy NPP fraction denoted $f_{canopy}$ and decomposed into leaf, twig and fruit production. Carbon allocation to leaf results in a new young leaf pool, whereas other leaf pools are updated as follow:

\begin{equation}
  \begin{array}{c} \\
   \Delta LA_{young} = \frac{2*f_{leaves}*NPP_{ind}}{LMA}-\frac{LA_{young}}{\tau_{young}} \\
  \Delta LA_{mature} = \frac{LA_{young}}{\tau_{young}} - \frac{LA_{mature}}{\tau_{mature}}\\
  \Delta LA_{old} = \frac{LA_{mature}}{\tau_{mature}} - \frac{LA_{old}}{\tau_{old}}
  \end{array}
  (\#eq:DeltaLA)
\end{equation}

$\tau_{young}$, $\tau_{mature}$, and $\tau_{old}$ are species residence times in each leaf pools ($years$). The sum of residency time thus defined the leaf lifespan $LL = \tau_{young} + \tau_{mature} + \tau_{old}$ ($years$). $\tau_{young}$ is set to one month and $\tau_{mature}$ is set to a third of leaf lifespan $LL$. Previous implementation of TROLL model used @Reich1991a allometry to infer leaf lifespan $LL$ from species leaf mass per area $LMA$ [@Li]. But the use of the allometrie from @Reich1991a with current implementation of the TROLL model resulted in an underestimation of leaf lifespan for low LMA species. Consequently in the following paragraph we suggest a new allometry. Belowground carbon allocation is not simulated inside TROLL.

## Leaf lifespan

The underestimation of leaf lifespan for low LMA species with the allometry from @Reich1991a resulted in indivduals unealistic early death from carbon starvation. We gathered data from TRY[@Kattge2011], DRYAD [@chave_towards_2009] and GLOPNET [@wright_worldwide_2004] datasets. We used an out of the bag method applied on a random forest to select variables with highest importance to explain leaf lifespan. We thus selected leaf mass per are $LMA$, leaf nitrogen content $N$ and wood specific gravity $wsg$. We then used a bayesian approach to test different models with growing level of complexity. The model with the best tradeoff between complexity (number of parameters), convergence, likelihood, and prediction quality (root mean square error of prediction RMSEP) was kept. We selected following model with a maximum likelihood of 13.6 and a RMSEP of 12 months:

\begin{equation}
  LL_{d} \sim log\mathcal{N}({\beta_1}_d*LMA - {\beta_2}_d*N*\beta_3*wsg, \sigma)
  (\#eq:LLb)
\end{equation}

Leaf lifespan $LL$ follows a lognormal law with location infered from leaf lifespan $LMA$, nitrogen content $N$ and wood specific gravity $wsg$ and a scale $\sigma$. Each ${\beta_i}_d$ is following a normal law located on $\beta_i$ with a scale of $\sigma_i$. All $\beta_i$, $\sigma_i$, and $\sigma$ are assumed without presemption following a gamma law. $d$ represents the dataset random effects and encompass environmental and protocol variations. The sampling of model \@ref(eq:LLb) resulted in the following allometry:

\begin{equation}
  LL = e^{0.017*LMA - 0.103*Nmass + 1.94*wsg}
  (\#eq:LL)
\end{equation}

## Tree growth

Once the increment of stem volume $\Delta V$ calculated with equation \@ref(eq:DeltaV), TROLL convert it into an increment of tree diameter at breast height denoted $\Delta dbh$. TROLL infer tree height from $dbh$ using a Michaelis-Menten equation:

\begin{equation}
  h = h_{lim}*\frac{dbh}{dbh + a_h}
  (\#eq:h)
\end{equation}

On the other hand, we have the trunk volume $V = C * \pi * (\frac{dbh}{2})^2*h$, thus:

\begin{equation}
  \begin{array}{c} \\
    \Delta V = C*\frac{1}{2}*\pi*h*dbh*\Delta dbh + C * \pi * (\frac{dbh}{2})^2*h \\
    \Delta V = V*\frac{\Delta dbh}{dbh}*(3-\frac{dbh}{dbh + ah})
  \end{array}
  (\#eq:Deltadbh)
\end{equation}

Next, TROLL used the new trunk dimension ($dbh$ and $h$) to update tree crown geometry using allometric equations [@Chave2005]:

\begin{equation}
  \begin{array}{c} \\
    CR = 0.80 + 10.47*dbh - 3.33*dbh^2\\
    CD = -0.48 + 0.26*h~;~CD = 0.13 + 0.17*h~(h<5~m)
  \end{array}
  (\#eq:C)
\end{equation}

Finally, TROLL computes the mean leaf density within the crown ($LD$ in $m^2.m^{-3}$) assuming a uniform distribution:

\begin{equation}
  LD = \frac{LA_{young}+LA_{mature}+LA_{old}}{\pi*CR^2*CD}
  (\#eq:LD)
\end{equation}

## Mortality

Mortality is partitioned in three factors inside TROLL: background death $d_b$, treefall death $d_t$ and negative density dependent death $d_{NDD}$. Because density dependent death $d_{NDD}$ is still in development inside TROLL we did not used it, so we will not detail is computation. 

@chave_towards_2009 advocated for a wood economics spectrum opposing fast growing light wood species species with high risk of mortality to slow growing dense wood species with reduced risk of mortality. Hence, background mortality is derived from wood specific gravity $wsg$ inside TROLL:

\begin{equation}
  d_b = m*(1-\frac{wsg}{wsg_{lim}})+d_n
  (\#eq:db)
\end{equation}

$m$ ($events.year^{-1}$) is the reference background death rate for lighter wood species (pioneers). $d_n$ represents death by carbohydrates shortage. If the number of consecutive day with $NPP_{ind}
< 0$ \@ref(eq:NPP) is superior to tree leaf lifespan $d_n$ is set to 1 and remains null in other cases.

Mortality by treefall inside TROLL depends on a specifric stochastic threshold $\theta$:

\begin{equation}
  \theta = h_{max}*(1-v_T*|\zeta|)
  (\#eq:theta)
\end{equation}

$h_{max}$ is the maximal tree height. $v_T$ is the variance term set to 0.3. $|\zeta|$ is the absolute value of a random centered and scaled Gaussian. If the tree hieght $h$ is superior to $\theta$ then the tree may fall with a probability $1-\theta/h$ [@Chave1999]. The treefall direction is random (drawn from a uniform law ($\mathcal{U}[0,2\pi]$). All tree in the trajectory of the falling tree will be hurted through a variable denoted $hurt$, incremented by fallen tree height $h$. If a tree height is inferior than its $hurt$ values then it may die with a probability $1-\frac{1}{2}\frac{h}{hurt}$. $hurt$ variable is reset to null at each timestep ($month$).

## Recruitment

Once the tree became fertile they will start to disperse seeds. TROLL consider tree as fertile after a specific height threshold $h_{mature}$ [@Wright2005]:

\begin{equation}
  h_{mature} = -11.47+0.90*h_{max}
  (\#eq:hmature)
\end{equation}

But TROLL is not considering seed directly through a seedbank, instead seed might be interpreted as a seedling recruitment opportunity. The number of reproduction opportunities per mature tree is denoted $n_s$ and set to 10 for all species. This assumption originates from a trade-off between seed number and seed size resulting in equivalent survival and recruitment probability. All $n_s$ events are dispersed with a distance randomly drawn from a Gaussian distribution. Additionally, TROLL model consider external seedrain through $n_{ext}$ events of seed immigration:

\begin{equation}
  n_{ext} = N_{tot}*f_{reg}*n_{ha}
  (\#eq:next)
\end{equation}

N_{tot} is the external seedrain per hectare (number of reproduction opportunities). $f_{reg}$ is the species regional frequency. $n_{ha}$ is the simulated plot size in $ha$.

Finally, a bank of seedlings to be recruited is defined for each pixel. If the ground-level light reaches a species light compensation point $LCP$ the species will be recruited:

\begin{equation}
  LCP = \frac{R_{leaf}}{\phi}
  (\#eq:LCP)
\end{equation}

$R_{leaf}$ is the leaf respiration for maintenance (see \@ref(eq:Rl)). $\phi$ is the quantum yield ($\mu mol C.\mu mol~photon$) set to 0.06. If several species reach their $LCP$, one is picked at random. Seedlings are recruited with following intial geometry:

\begin{equation}
  \begin{array}{c} \\
    dbh = \frac{a_h}{h_{max} - 1}\\
    h = 1~m\\
    CR = 0.5~m\\
    CD = 0.3~m\\
    LD = 0.8~m^2.^{-3}
  \end{array}
  (\#eq:C)
\end{equation}


